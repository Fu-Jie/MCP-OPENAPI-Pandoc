# ============================================================================
# GitHub Actions Workflow: Ëá™Âä®ÂèëÂ∏ÉÂÆπÂô®ÈïúÂÉèÂà∞ GHCR
# ============================================================================
#
# @description  Ëá™Âä®ÊûÑÂª∫Â§öÊû∂ÊûÑ Docker ÈïúÂÉèÂπ∂ÂèëÂ∏ÉÂà∞ GitHub Container Registry
# @author       DevOps Team
# @created      2025-12-30
# @updated      2025-12-30
#
# @triggers
#   - push:
#       tags: ['v*.*.*']        # ËØ≠‰πâÂåñÁâàÊú¨Ê†áÁ≠æËß¶ÂèëÁîü‰∫ßÂèëÂ∏É
#   - workflow_dispatch:         # ÊâãÂä®Ëß¶ÂèëÔºàÁî®‰∫éÁ¥ßÊÄ•‰øÆÂ§çÔºâ
#   - schedule:                  # ÂÆöÊó∂ÊûÑÂª∫ÔºàÊØèÂë®Êó•ÈáçÂª∫Âü∫Á°ÄÈïúÂÉèÔºâ
#
# @outputs
#   - ÈïúÂÉèÂú∞ÂùÄ: ghcr.io/${{ github.repository }}:latest
#   - ÊîØÊåÅÊû∂ÊûÑ: linux/amd64, linux/arm64
#   - ÈôÑÂä†‰∫ßÁâ©: SBOM, ÊºèÊ¥ûÊâ´ÊèèÊä•Âëä
#
# @permissions
#   - contents: read    # ËØªÂèñ‰ªìÂ∫ì‰ª£Á†Å
#   - packages: write   # Êé®ÈÄÅÂà∞ GHCR
#   - id-token: write   # Áî®‰∫é OIDC ËÆ§ËØÅÔºàÂèØÈÄâÔºâ
#
# @dependencies
#   - docker/setup-buildx-action@v3
#   - docker/login-action@v3
#   - docker/metadata-action@v5
#   - docker/build-push-action@v5
#
# ============================================================================

name: "üöÄ Publish Container to GHCR"

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      release_version:
        description: "ÊâãÂä®ÊåáÂÆöÂèëÂ∏ÉÁâàÊú¨ÔºàÂèØÈÄâÔºåÁ§∫‰æãÔºöv1.2.3Ôºâ"
        required: false
        type: string
      push_latest:
        description: "ÊòØÂê¶ÂêåÊó∂Êé®ÈÄÅ latest Ê†áÁ≠æ"
        default: true
        required: false
        type: boolean
      enable_cosign:
        description: "ÂêØÁî® Cosign ÈïúÂÉèÁ≠æÂêçÔºàÈúÄË¶Å OIDC ÊàñÂØÜÈí•Ôºâ"
        default: false
        required: false
        type: boolean
  schedule:
    - cron: "0 3 * * 0" # ÊØèÂë®Êó• 03:00 UTC ÈáçÂª∫Âü∫Á°ÄÈïúÂÉè

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: false # Áîü‰∫ßÂèëÂ∏É‰∏çÂº∫Âà∂ÂèñÊ∂àÔºåÈÅøÂÖçÂèëÂ∏É‰∏≠Êñ≠

permissions:
  contents: read
  packages: write
  id-token: write

env:
  REGISTRY: ghcr.io
  BUILD_PLATFORMS: "linux/amd64,linux/arm64"
  DOCKERFILE: "Dockerfile.example"
  BUILDX_INSTANCE: "gha-multiarch-builder"
  SBOM_PATH: "artifacts/sbom.json"
  MANIFEST_REPORT: "artifacts/manifest.txt"
  SMOKE_REPORT: "artifacts/smoke-tests.txt"
  ENABLE_COSIGN_SIGNING: "${{ inputs.enable_cosign || 'false' }}"
  PUSH_LATEST: "${{ inputs.push_latest || 'true' }}"

jobs:
  build-and-push:
    name: "üì¶ Multi-Arch Build & Publish"
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: "üì• Checkout repository"
        # ----------------------------------------------------------------
        # ÂäüËÉΩËØ¥ÊòéÔºöËé∑Âèñ‰ª£Á†Å‰ªìÂ∫ìÂÜÖÂÆπÔºåÁ°Æ‰øùÂåÖÂê´ÂÖ®ÈÉ®ÂéÜÂè≤‰ª•‰æø metadata Ëß£ÊûêÊ†áÁ≠æ
        # ËæìÂÖ•ÔºöGITHUB_TOKENÔºàËá™Âä®Êèê‰æõÔºâ
        # ËæìÂá∫ÔºöÂ∑•‰ΩúÁõÆÂΩï‰ª£Á†Å
        # ÈîôËØØÂ§ÑÁêÜÔºöËã•Ê£ÄÂá∫Â§±Ë¥•ÔºåÂêéÁª≠Ê≠•È™§Êó†Ê≥ïÊâßË°å
        # ----------------------------------------------------------------
        uses: actions/checkout@v4.1.7
        with:
          fetch-depth: 0

      - name: "üî° Set lowercase image name"
        # ----------------------------------------------------------------
        # ÂäüËÉΩËØ¥ÊòéÔºöGHCR Ë¶ÅÊ±Ç‰ªìÂ∫ìÂêçÂøÖÈ°ªÂ∞èÂÜôÔºåËΩ¨Êç¢ github.repository
        # ----------------------------------------------------------------
        id: image_name
        run: |
          IMAGE_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "image_name=${IMAGE_NAME}" >> "$GITHUB_OUTPUT"
          echo "validation_tag=ghcr.io/${IMAGE_NAME}:${{ github.sha }}" >> "$GITHUB_OUTPUT"

      - name: "üß≠ Determine release ref"
        # ----------------------------------------------------------------
        # ÂäüËÉΩËØ¥ÊòéÔºöÁªü‰∏ÄÂèëÂ∏ÉÂºïÁî®ÔºåÊâãÂä®Ëß¶ÂèëÊó∂ÂÖÅËÆ∏Ë¶ÜÁõñÁâàÊú¨Âè∑
        # ËæìÂá∫ÔºöÁéØÂ¢ÉÂèòÈáè RESOLVED_REF/RESOLVED_VERSION
        # ÈîôËØØÂ§ÑÁêÜÔºöÈùûÊ≥ïÁâàÊú¨Ê†ºÂºè‰ºö‰∏≠Ê≠¢ÂèëÂ∏É
        # ----------------------------------------------------------------
        id: release_ref
        run: |
          set -eo pipefail
          SEMVER_REGEX='^v[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?(\+[0-9A-Za-z.-]+)?$'
          REF_NAME="${GITHUB_REF_NAME}"
          if [ -n "${{ inputs.release_version || '' }}" ]; then
            REF_NAME="${{ inputs.release_version }}"
          fi
          if ! echo "${REF_NAME}" | grep -Eq "${SEMVER_REGEX}"; then
            echo "::warning::Êú™Êèê‰æõÊúâÊïàËØ≠‰πâÂåñÁâàÊú¨Ôºå‰ΩøÁî®ÂΩìÂâçÂºïÁî® ${REF_NAME}"
          fi
          echo "resolved_ref=${REF_NAME}" >> "$GITHUB_OUTPUT"

      - name: "üîß Resolve latest tag gate"
        # ----------------------------------------------------------------
        # ÂäüËÉΩËØ¥ÊòéÔºöÈõÜ‰∏≠ËÆ°ÁÆó latest Ê†áÁ≠æÊòØÂê¶Â∫îÂêØÁî®Ôºå‰æø‰∫éÂÆ°ËÆ°‰∏éÁª¥Êä§
        # ----------------------------------------------------------------
        id: tag_gate
        run: |
          set -euo pipefail
          enable="false"
          if [[ "${GITHUB_EVENT_NAME}" == "push" && "${GITHUB_REF}" == refs/tags/* ]]; then
            enable="true"
          elif [[ "${GITHUB_EVENT_NAME}" == "schedule" ]]; then
            enable="true"
          elif [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            case "${{ inputs.push_latest || 'true' }}" in
              true|TRUE|1|"") enable="true" ;;
              *) enable="false" ;;
            esac
          fi
          echo "enable_latest=${enable}" >> "$GITHUB_OUTPUT"

      - name: "üõ†Ô∏è Setup QEMU for emulation"
        # ----------------------------------------------------------------
        # ÂäüËÉΩËØ¥ÊòéÔºöÂÆâË£Ö QEMU ‰ª•ÊîØÊåÅË∑®Êû∂ÊûÑÊûÑÂª∫Ôºàarm64Ôºâ
        # ËæìÂÖ•ÔºöÊó†ÈúÄÈ¢ùÂ§ñËæìÂÖ•
        # ËæìÂá∫ÔºöÂèØÁî®ÁöÑ QEMU ÁéØÂ¢É
        # ÈîôËØØÂ§ÑÁêÜÔºöÂÆâË£ÖÂ§±Ë¥•Â∞ÜÈòªÊñ≠ÂêéÁª≠Â§öÊû∂ÊûÑÊûÑÂª∫
        # ----------------------------------------------------------------
        uses: docker/setup-qemu-action@v3.2.0
        with:
          image: tonistiigi/binfmt:latest
          platforms: all

      - name: "üèóÔ∏è Setup Docker Buildx"
        # ----------------------------------------------------------------
        # ÂäüËÉΩËØ¥ÊòéÔºöÂàõÂª∫ÈöîÁ¶ªÁöÑ buildx builderÔºåÂêØÁî®Â§öÊû∂ÊûÑ‰∏éÁºìÂ≠ò
        # ËæìÂÖ•ÔºöBUILDX_INSTANCE
        # ËæìÂá∫ÔºöÂèØÁî®ÁöÑ buildx builder
        # ÈîôËØØÂ§ÑÁêÜÔºöÂàõÂª∫Â§±Ë¥•ÂêéÁª≠ÊûÑÂª∫Êó†Ê≥ïËøõË°å
        # ----------------------------------------------------------------
        id: buildx
        uses: docker/setup-buildx-action@v3.7.1
        with:
          install: true
          driver: docker-container
          buildkitd-flags: "--debug"
          use: true
          name: "${{ env.BUILDX_INSTANCE }}"

      - name: "üóÑÔ∏è Restore buildx cache"
        # ----------------------------------------------------------------
        # ÂäüËÉΩËØ¥ÊòéÔºöÊÅ¢Â§ç GHA Â±ÇÁºìÂ≠ò‰ª•Áº©Áü≠ÊûÑÂª∫Êó∂Èó¥
        # ËæìÂÖ•Ôºöcache key ÁªëÂÆö workflow + ref
        # ËæìÂá∫ÔºöÊú¨Âú∞ÁºìÂ≠òÁõÆÂΩï
        # ÈîôËØØÂ§ÑÁêÜÔºöÁºìÂ≠òÁº∫Â§±‰ªÖÂΩ±ÂìçÊÄßËÉΩ‰∏çÂΩ±ÂìçÂäüËÉΩ
        # ----------------------------------------------------------------
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: buildx-${{ github.workflow }}-${{ github.ref_name }}-${{ hashFiles(env.DOCKERFILE, '**/pyproject.toml') }}
          restore-keys: |
            buildx-${{ github.workflow }}-${{ github.ref_name }}-
            buildx-${{ github.workflow }}-

      - name: "üîë Login to GHCR"
        # ----------------------------------------------------------------
        # ÂäüËÉΩËØ¥ÊòéÔºö‰ΩøÁî® GitHub Token ÁôªÂΩï GHCR
        # ËæìÂÖ•ÔºöGITHUB_TOKENÔºàpackages:write ÊùÉÈôêÔºâ
        # ËæìÂá∫ÔºöÂ∑≤È™åËØÅÁöÑ Docker login session
        # ÈîôËØØÂ§ÑÁêÜÔºöËÆ§ËØÅÂ§±Ë¥•Â∞ÜÈòªÊ≠¢Êé®ÈÄÅÈïúÂÉè
        # ----------------------------------------------------------------
        uses: docker/login-action@v3.3.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "üì¶ Extract metadata (tags, labels)"
        # ----------------------------------------------------------------
        # ÂäüËÉΩËØ¥ÊòéÔºö‰ªé Git ÂºïÁî®‰∏≠ÊèêÂèñËØ≠‰πâÂåñÁâàÊú¨Âπ∂ÁîüÊàê OCI Ê†áÁ≠æ
        # 
        # ËæìÂÖ•Ôºö
        #   - github.ref: refs/tags/v1.2.3
        # ËæìÂá∫Ôºö
        #   - tags: latest, v1.2.3, v1.2, v1, commit SHA
        #   - labels: org.opencontainers.image.*
        # 
        # ÈîôËØØÂ§ÑÁêÜÔºö
        #   - ÈùûÊ≥ïÊ†áÁ≠æÊ†ºÂºèÂ∞ÜÂõûÈÄÄÂà∞ commit SHA
        # ----------------------------------------------------------------
        id: meta
        uses: docker/metadata-action@v5.5.1
        with:
          images: |
            ghcr.io/${{ steps.image_name.outputs.image_name }}
          tags: |
            type=raw,value=latest,enable=${{ steps.tag_gate.outputs.enable_latest == 'true' }}
            type=raw,value=${{ github.sha }}
            type=semver,pattern={{version}},prefix=v
            type=semver,pattern={{major}}.{{minor}},prefix=v
            type=semver,pattern={{major}},prefix=v
            type=sha,format=long
          labels: |
            org.opencontainers.image.title=${{ github.repository }}
            org.opencontainers.image.description=Pandoc MCP container image with multi-arch support
            org.opencontainers.image.url=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.licenses=MIT

      - name: "üßÆ Render tag summary"
        # ----------------------------------------------------------------
        # ÂäüËÉΩËØ¥ÊòéÔºöÂàóÂá∫ÂÆûÈôÖÂ∞ÜË¶ÅÊé®ÈÄÅÁöÑÊ†áÁ≠æÔºå‰æø‰∫éÂÆ°ËÆ°
        # ËæìÂá∫Ôºöhuman readable summary
        # ----------------------------------------------------------------
        run: |
          echo "Tags to be published:"
          printf '%s\n' "${{ steps.meta.outputs.tags }}"

      - name: "üîê Optional: Install Cosign"
        # ----------------------------------------------------------------
        # ÂäüËÉΩËØ¥ÊòéÔºöÂú®ÈúÄË¶ÅÁ≠æÂêçÊó∂ÂÆâË£Ö cosignÔºà‰ΩøÁî® OIDC ÊàñÂØÜÈí•Ôºâ
        # Êù°‰ª∂ÔºöENABLE_COSIGN_SIGNING == 'true'
        # ----------------------------------------------------------------
        if: env.ENABLE_COSIGN_SIGNING == 'true'
        uses: sigstore/cosign-installer@v3.5.0
        with:
          cosign-release: "v2.4.0"

      - name: "üèóÔ∏è Build & Push multi-arch image"
        # ----------------------------------------------------------------
        # ÂäüËÉΩËØ¥ÊòéÔºö‰ΩøÁî® buildx ÊûÑÂª∫Âπ∂Êé®ÈÄÅÂ§öÊû∂ÊûÑÈïúÂÉèÔºåÂêØÁî®‰∏âÂ±ÇÁºìÂ≠ò
        # ÁºìÂ≠òÔºö
        #   - Registry cache: ${{ env.CACHE_REGISTRY }}
        #   - GitHub Actions cache: actions/cache ÁõÆÂΩï
        #   - Êú¨Âú∞ buildx cache: /tmp/.buildx-cache
        # ----------------------------------------------------------------
        id: build_push
        uses: docker/build-push-action@v5.3.0
        with:
          context: .
          file: ${{ env.DOCKERFILE }}
          pull: true
          push: true
          provenance: false
          sbom: true
          platforms: ${{ env.BUILD_PLATFORMS }}
          builder: ${{ steps.buildx.outputs.name }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: |
            type=gha,scope=${{ github.workflow }}-${{ github.ref_name }}
            type=local,src=/tmp/.buildx-cache
          cache-to: |
            type=gha,mode=max,scope=${{ github.workflow }}-${{ github.ref_name }}
            type=local,dest=/tmp/.buildx-cache-new,mode=max
          outputs: type=image,push=true

      - name: "üîÑ Move local cache"
        # ----------------------------------------------------------------
        # ÂäüËÉΩËØ¥ÊòéÔºöÂ∞ÜÊñ∞ÁºìÂ≠òÁõÆÂΩïË¶ÜÁõñÊóßÁõÆÂΩïÔºå‰øùÊåÅÁºìÂ≠òÂèØÂ§çÁî®
        # ----------------------------------------------------------------
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: "üõ°Ô∏è Cosign sign image"
        # ----------------------------------------------------------------
        # ÂäüËÉΩËØ¥ÊòéÔºöÂΩìÂêØÁî®Êó∂ÂØπÈïúÂÉèËøõË°åÁ≠æÂêçÔºàÁ§∫‰æã‰ΩøÁî® OIDCÔºâ
        # Êù°‰ª∂ÔºöENABLE_COSIGN_SIGNING == 'true'
        # ----------------------------------------------------------------
        if: env.ENABLE_COSIGN_SIGNING == 'true'
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          set -euo pipefail
          TARGET_IMAGE="ghcr.io/${{ steps.image_name.outputs.image_name }}@${{ steps.build_push.outputs.digest }}"
          cosign sign --yes "${TARGET_IMAGE}"

      - name: "üßæ Inspect multi-arch manifest"
        # ----------------------------------------------------------------
        # ÂäüËÉΩËØ¥ÊòéÔºöÈ™åËØÅÂ§öÊû∂ÊûÑ manifest ÊòØÂê¶ÂåÖÂê´ÊúüÊúõÊû∂ÊûÑ
        # ËæìÂá∫Ôºömanifest Êä•ÂëäÂÜôÂÖ• $MANIFEST_REPORT
        # ----------------------------------------------------------------
        run: |
          mkdir -p "$(dirname "${MANIFEST_REPORT}")"
          docker buildx imagetools inspect "${{ steps.image_name.outputs.validation_tag }}" | tee "${MANIFEST_REPORT}"

      - name: "üö¶ Smoke test (linux/amd64)"
        # ----------------------------------------------------------------
        # ÂäüËÉΩËØ¥ÊòéÔºöÊãâÂèñÂπ∂ËøêË°å amd64 ÈïúÂÉèËøõË°åÂÜíÁÉüÊµãËØï
        # ----------------------------------------------------------------
        run: |
          docker pull --platform linux/amd64 "${{ steps.image_name.outputs.validation_tag }}"
          docker run --rm --platform linux/amd64 "${{ steps.image_name.outputs.validation_tag }}" --help | head -n 20 | tee -a "${SMOKE_REPORT}"

      - name: "üö¶ Smoke test (linux/arm64 via QEMU)"
        # ----------------------------------------------------------------
        # ÂäüËÉΩËØ¥ÊòéÔºöÊãâÂèñÂπ∂ËøêË°å arm64 ÈïúÂÉèËøõË°åÂÜíÁÉüÊµãËØïÔºà‰æùËµñ QEMUÔºâ
        # ----------------------------------------------------------------
        run: |
          docker pull --platform linux/arm64 "${{ steps.image_name.outputs.validation_tag }}"
          docker run --rm --platform linux/arm64 "${{ steps.image_name.outputs.validation_tag }}" --help | head -n 20 | tee -a "${SMOKE_REPORT}"

      - name: "üì§ Upload reports"
        # ----------------------------------------------------------------
        # ÂäüËÉΩËØ¥ÊòéÔºö‰∏ä‰º† manifest ‰∏é smoke test Êä•ÂëäÁî®‰∫éÂÆ°ËÆ°
        # ----------------------------------------------------------------
        uses: actions/upload-artifact@v4.4.0
        with:
          name: publish-reports
          path: |
            ${{ env.MANIFEST_REPORT }}
            ${{ env.SMOKE_REPORT }}

      - name: "üßπ Cleanup builder"
        # ----------------------------------------------------------------
        # ÂäüËÉΩËØ¥ÊòéÔºöÊ∏ÖÁêÜÊûÑÂª∫Âô®‰∏éÊÇ¨ÊåÇËµÑÊ∫êÔºåÈÅøÂÖçÁ£ÅÁõòÊ≥ÑÈú≤
        # ----------------------------------------------------------------
        if: always()
        run: |
          docker buildx rm "${{ steps.buildx.outputs.name }}" || true

      - name: "‚ùó Handle build failure"
        # ----------------------------------------------------------------
        # ÂäüËÉΩËØ¥ÊòéÔºöÁªü‰∏ÄÂ§ÑÁêÜÂ§±Ë¥•ÔºåËæìÂá∫ÈîôËØØÂπ∂ÂèëÈÄÅÈÄöÁü•
        # ----------------------------------------------------------------
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          EMAIL_SMTP_ENDPOINT: ${{ secrets.EMAIL_SMTP_ENDPOINT }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          NOTIFY_FROM_EMAIL: ${{ secrets.NOTIFY_FROM_EMAIL || 'github-actions@users.noreply.github.com' }}
          SMTP_USERNAME: ${{ secrets.EMAIL_SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.EMAIL_SMTP_PASSWORD }}
        run: |
          echo "::error::ÊûÑÂª∫Â§±Ë¥•ËØ¶ÊÉÖÔºåÊ£ÄÊü•‰∏äÊñπÊó•Âøó„ÄÇ"
          docker buildx inspect "${{ steps.buildx.outputs.name }}" >/tmp/buildx-inspect.log 2>&1 || true
          docker info >/tmp/docker-info.log 2>&1 || true
          echo "Buildx inspect (last 120 lines):"
          tail -n 120 /tmp/buildx-inspect.log || true
          echo "Docker info (last 120 lines):"
          tail -n 120 /tmp/docker-info.log || true
          if [ -n "${SLACK_WEBHOOK_URL:-}" ]; then
            payload=$(jq -n --arg text "GHCR ÂèëÂ∏ÉÂ§±Ë¥•Ôºö${GITHUB_REPOSITORY} @ ${GITHUB_REF}. ËØ∑Ê£ÄÊü•Êó•Âøó„ÄÇ" '{text:$text}')
            curl -X POST -H "Content-Type: application/json" -d "${payload}" "${SLACK_WEBHOOK_URL}"
          fi
          if [ -n "${EMAIL_SMTP_ENDPOINT:-}" ] && [ -n "${EMAIL_TO:-}" ]; then
            python - <<'PY'
            import os, smtplib, ssl, sys
            from email.message import EmailMessage
            msg = EmailMessage()
            msg["Subject"] = "GHCR ÂèëÂ∏ÉÂ§±Ë¥•ÂëäË≠¶"
            msg["From"] = os.environ.get("NOTIFY_FROM_EMAIL", "github-actions@users.noreply.github.com")
            msg["To"] = os.environ["EMAIL_TO"]
            msg.set_content(f"‰ªìÂ∫ì {os.environ['GITHUB_REPOSITORY']} ÂèëÂ∏ÉÂ§±Ë¥•ÔºåÂèÇËÄÉËøêË°å {os.environ['GITHUB_RUN_ID']}")
            context = ssl.create_default_context()
            try:
                with smtplib.SMTP(os.environ["EMAIL_SMTP_ENDPOINT"]) as smtp:
                    smtp.starttls(context=context)
                    user = os.environ.get("SMTP_USERNAME")
                    pwd = os.environ.get("SMTP_PASSWORD")
                    if user and pwd:
                        smtp.login(user, pwd)
                    smtp.send_message(msg)
            except Exception as exc:
                print(f"::warning::ÈÇÆ‰ª∂ÂèëÈÄÅÂ§±Ë¥•: {exc}", file=sys.stderr)
            PY
          fi
