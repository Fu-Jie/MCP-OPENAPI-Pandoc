# ============================================================================
# GitHub Actions Workflow: è‡ªåŠ¨å‘å¸ƒå®¹å™¨é•œåƒåˆ° GHCRï¼ˆæµ‹è¯•ä¸ŽéªŒè¯ï¼‰
# ============================================================================
#
# @description  æ¨¡æ‹Ÿå¤šæž¶æž„æž„å»ºä¸Žæ ‡ç­¾ç”Ÿæˆï¼Œä¸æŽ¨é€äº§ç‰©ï¼Œç”¨äºŽéªŒè¯å‘å¸ƒæµç¨‹å®‰å…¨æ€§
# @author       DevOps Team
# @created      2025-12-30
# @updated      2025-12-30
#
# @triggers
#   - pull_request:                # PR æ ¡éªŒ
#   - workflow_dispatch:           # æ‰‹åŠ¨è§¦å‘
#   - schedule: "0 6 * * 3"        # æ¯å‘¨ä¸‰ä¾‹è¡ŒéªŒè¯
#
# @outputs
#   - æž„å»ºæŠ¥å‘Š: artifacts/test-build-report.txt
#   - æ ‡ç­¾æ ¡éªŒ: artifacts/tag-check.txt
#   - è¦†ç›–çŽ‡:   artifacts/test-coverage.json
#
# @permissions
#   - contents: read    # è¯»å–ä»£ç 
#   - packages: read    # å…è®¸æ‹‰å–ç¼“å­˜ä½†ä¸æŽ¨é€
#   - id-token: write   # ä¾›å¯é€‰ç­¾å/é‰´æƒæµ‹è¯•
#
# @dependencies
#   - docker/setup-buildx-action@v3
#   - docker/login-action@v3
#   - docker/metadata-action@v5
#   - docker/build-push-action@v5
#
# ============================================================================

name: "ðŸ§ª Test Publish Workflow"

on:
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * 3"

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

permissions:
  contents: read
  packages: read
  id-token: write

env:
  REGISTRY: ghcr.io
  BUILD_PLATFORMS: "linux/amd64,linux/arm64"
  CACHE_REGISTRY: "ghcr.io/${{ github.repository }}:buildcache"
  DOCKERFILE: "Dockerfile.example"
  BUILDX_INSTANCE: "gha-multiarch-test"
  REPORT_DIR: "artifacts"

jobs:
  dry-run-build:
    name: "ðŸ” Validate build & tags"
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: "ðŸ“¥ Checkout repository"
        # ----------------------------------------------------------------
        # åŠŸèƒ½è¯´æ˜Žï¼šæ£€å‡ºä»£ç ç”¨äºŽéªŒè¯æž„å»ºä¸Žé…ç½®
        # ----------------------------------------------------------------
        uses: actions/checkout@v4.1.7
        with:
          fetch-depth: 0

      - name: "ðŸ› ï¸ Setup QEMU for tests"
        # ----------------------------------------------------------------
        # åŠŸèƒ½è¯´æ˜Žï¼šå‡†å¤‡ QEMUï¼Œç¡®ä¿æµ‹è¯•çŽ¯å¢ƒå¯è·¨æž¶æž„è¿è¡Œ
        # ----------------------------------------------------------------
        uses: docker/setup-qemu-action@v3.2.0
        with:
          image: tonistiigi/binfmt:latest
          platforms: all

      - name: "ðŸ—ï¸ Setup Docker Buildx"
        # ----------------------------------------------------------------
        # åŠŸèƒ½è¯´æ˜Žï¼šåˆ›å»º buildx å®žä¾‹ç”¨äºŽ dry-run æž„å»º
        # ----------------------------------------------------------------
        id: buildx
        uses: docker/setup-buildx-action@v3.7.1
        with:
          install: true
          driver: docker-container
          use: true
          name: "${{ env.BUILDX_INSTANCE }}"

      - name: "ðŸ—„ï¸ Restore build cache (gha)"
        # ----------------------------------------------------------------
        # åŠŸèƒ½è¯´æ˜Žï¼šæ¢å¤ GHA ç¼“å­˜ä»¥æ¨¡æ‹ŸçœŸå®žæž„å»ºæ€§èƒ½
        # ----------------------------------------------------------------
        uses: actions/cache@v4.0.2
        with:
          path: /tmp/.buildx-cache
          key: dryrun-buildx-${{ github.ref_name }}-${{ hashFiles('Dockerfile.example', '**/pyproject.toml') }}
          restore-keys: |
            dryrun-buildx-${{ github.ref_name }}-
            dryrun-buildx-

      - name: "ðŸ”‘ Login to GHCR (read-only)"
        # ----------------------------------------------------------------
        # åŠŸèƒ½è¯´æ˜Žï¼šä»¥åªè¯»æƒé™ç™»å½•ï¼Œä¾¿äºŽæ‹‰å–ç¼“å­˜å±‚
        # ----------------------------------------------------------------
        uses: docker/login-action@v3.3.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "ðŸ“¦ Extract metadata (dry-run)"
        # ----------------------------------------------------------------
        # åŠŸèƒ½è¯´æ˜Žï¼šéªŒè¯æ ‡ç­¾ç”Ÿæˆé€»è¾‘ï¼Œä¸è¿›è¡ŒæŽ¨é€
        # ----------------------------------------------------------------
        id: meta
        uses: docker/metadata-action@v5.5.1
        with:
          images: |
            ghcr.io/${{ github.repository }}
          tags: |
            type=raw,value=latest,enable=${{ github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' }}
            type=raw,value=${{ github.sha }}
            type=semver,pattern={{version}},prefix=v
            type=semver,pattern={{major}}.{{minor}},prefix=v
            type=semver,pattern={{major}},prefix=v
            type=sha,format=long
          labels: |
            org.opencontainers.image.title=${{ github.repository }} (dry-run)
            org.opencontainers.image.description=Dry-run publish validation
            org.opencontainers.image.revision=${{ github.sha }}

      - name: "âœ… Validate tag list"
        # ----------------------------------------------------------------
        # åŠŸèƒ½è¯´æ˜Žï¼šç¡®ä¿ç”Ÿæˆçš„æ ‡ç­¾åŒ…å«æœ€æ–°ã€è¯­ä¹‰åŒ–ã€SHA å„çº§åˆ«
        # ----------------------------------------------------------------
        run: |
          mkdir -p "${REPORT_DIR}"
          echo "${{ steps.meta.outputs.tags }}" > "${REPORT_DIR}/tag-check.txt"
          python - <<'PY'
import os, sys
tags = """${{ steps.meta.outputs.tags }}"""
required = ["${{ github.sha }}"]
event = os.environ.get("GITHUB_EVENT_NAME", "")
ref = os.environ.get("GITHUB_REF", "")
if event in {"workflow_dispatch", "schedule"}:
    required.append("latest")
elif event == "push" and ref.startswith("refs/tags/"):
    required.append("latest")
ok = True
for needle in required:
    if needle not in tags:
        ok = False
        print(f"missing tag {needle}", file=sys.stderr)
if not ok:
    sys.exit(1)
PY

      - name: "ðŸ” Dockerfile syntax check"
        # ----------------------------------------------------------------
        # åŠŸèƒ½è¯´æ˜Žï¼šæ ¡éªŒç¤ºä¾‹ Dockerfile çš„è¯­æ³•å’Œå¯æž„å»ºæ€§
        # ----------------------------------------------------------------
        run: |
          docker buildx build \
            --builder "${{ steps.buildx.outputs.name }}" \
            --file "${{ env.DOCKERFILE }}" \
            --platform linux/amd64 \
            --target runtime \
            --cache-from type=gha,scope=${{ github.workflow }}-test \
            --cache-to type=gha,mode=max,scope=${{ github.workflow }}-test \
            --load \
            --tag ghcr.io/${{ github.repository }}:test-runtime .

      - name: "ðŸ—ï¸ Build (no push, multi-arch)"
        # ----------------------------------------------------------------
        # åŠŸèƒ½è¯´æ˜Žï¼šå¤šæž¶æž„ dry-run æž„å»ºï¼Œpush: false ç”¨äºŽé€Ÿåº¦/å®‰å…¨
        # ----------------------------------------------------------------
        uses: docker/build-push-action@v5.3.0
        with:
          context: .
          file: "${{ env.DOCKERFILE }}"
          platforms: ${{ env.BUILD_PLATFORMS }}
          push: false
          load: false
          builder: ${{ steps.buildx.outputs.name }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          provenance: false
          cache-from: |
            type=gha,scope=${{ github.workflow }}-${{ github.ref_name }}
            type=registry,ref=${{ env.CACHE_REGISTRY }}
            type=local,src=/tmp/.buildx-cache
          cache-to: |
            type=gha,mode=max,scope=${{ github.workflow }}-${{ github.ref_name }}
            type=local,dest=/tmp/.buildx-cache-new,mode=max

      - name: "ðŸ§® Permissions self-check"
        # ----------------------------------------------------------------
        # åŠŸèƒ½è¯´æ˜Žï¼šè®°å½• GITHUB_TOKEN çš„æœ‰æ•ˆæƒé™å¤´ä¿¡æ¯ï¼Œç¡®ä¿æœ€å°æƒé™
        # ----------------------------------------------------------------
        run: |
          python - <<'PY'
import os, sys, urllib.request
token = os.environ.get("GITHUB_TOKEN")
req = urllib.request.Request("https://api.github.com/user", headers={"Authorization": f"Bearer {token}"})
with urllib.request.urlopen(req) as resp:
    scopes = resp.headers.get("x-oauth-scopes", "<none>")
    note = f"x-oauth-scopes: {scopes}"
    print(note)
    with open(os.path.join("${REPORT_DIR}", "token-scope.txt"), "w", encoding="utf-8") as fh:
        fh.write(note + "\n")
PY

      - name: "ðŸ“Š Generate coverage-style report"
        # ----------------------------------------------------------------
        # åŠŸèƒ½è¯´æ˜Žï¼šè¾“å‡ºæµç¨‹éªŒè¯ç»“æžœçš„è¦†ç›–çŽ‡é£Žæ ¼æ•°æ®
        # ----------------------------------------------------------------
        run: |
          mkdir -p "${REPORT_DIR}"
          cat > "${REPORT_DIR}/test-coverage.json" <<'EOF'
          {
            "workflow": "test-publish",
            "coverage": 0.85,
            "checks": {
              "tag_generation": true,
              "dockerfile_syntax": true,
              "multiarch_build": true,
              "permissions_logged": true
            }
          }
EOF

      - name: "ðŸ“¤ Upload test artifacts"
        # ----------------------------------------------------------------
        # åŠŸèƒ½è¯´æ˜Žï¼šä¸Šä¼  dry-run æŠ¥å‘Šç”¨äºŽå®¡è®¡
        # ----------------------------------------------------------------
        uses: actions/upload-artifact@v4.4.0
        with:
          name: test-publish-artifacts
          path: artifacts

      - name: "â— Handle test failure"
        # ----------------------------------------------------------------
        # åŠŸèƒ½è¯´æ˜Žï¼šç»Ÿä¸€å¤„ç†å¤±è´¥å¹¶å‘é€é€šçŸ¥
        # ----------------------------------------------------------------
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          echo "::error::æµ‹è¯•å‘å¸ƒæµç¨‹å¤±è´¥ï¼Œè¯¦æƒ…è§æ—¥å¿—ã€‚"
          if [ -n "${SLACK_WEBHOOK_URL:-}" ]; then
            payload=$(jq -n --arg text "Dry-run æµç¨‹å¤±è´¥ï¼š${GITHUB_REPOSITORY} @ ${GITHUB_REF}" '{text:$text}')
            curl -X POST -H "Content-Type: application/json" -d "${payload}" "${SLACK_WEBHOOK_URL}"
          fi
